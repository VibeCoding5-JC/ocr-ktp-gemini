<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR KTP - Ekstrak Data KTP dengan AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    .drop-zone.dragover {
      @apply border-blue-500 bg-blue-50;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4">
      <div class="flex items-center space-x-3">
        <div class="bg-blue-600 p-2 rounded-lg">
          <i class="fas fa-id-card text-white text-xl"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-800">OCR KTP</h1>
          <p class="text-sm text-gray-500">Ekstrak data KTP dengan AI Gemini</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto px-4 py-8">
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Upload Section -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">
          <i class="fas fa-upload text-blue-600 mr-2"></i>
          Upload Foto KTP
        </h2>

        <!-- Drop Zone -->
        <div 
          id="dropZone" 
          class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all duration-300"
        >
          <div id="uploadPlaceholder">
            <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 font-medium">Drag & Drop foto KTP di sini</p>
            <p class="text-gray-400 text-sm mt-1">atau klik untuk memilih file</p>
            <p class="text-gray-400 text-xs mt-3">Format: JPG, PNG, WebP (Max 5MB)</p>
          </div>
          
          <!-- Preview -->
          <div id="previewContainer" class="hidden">
            <img id="imagePreview" class="max-h-64 mx-auto rounded-lg shadow-md" alt="Preview KTP">
            <p id="fileName" class="text-sm text-gray-600 mt-3"></p>
          </div>
        </div>

        <input type="file" id="fileInput" accept="image/*" class="hidden">

        <!-- Action Buttons -->
        <div class="mt-6 flex space-x-3">
          <button 
            id="extractBtn" 
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            <i class="fas fa-magic mr-2"></i>
            Ekstrak Data
          </button>
          <button 
            id="resetBtn" 
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300"
          >
            <i class="fas fa-redo"></i>
          </button>
        </div>

        <!-- Loading -->
        <div id="loadingSection" class="hidden mt-6">
          <div class="flex items-center justify-center space-x-3 text-blue-600">
            <svg class="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="font-medium">Menganalisis KTP dengan AI...</span>
          </div>
        </div>
      </div>

      <!-- Result Section -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">
          <i class="fas fa-file-alt text-green-600 mr-2"></i>
          Hasil Ekstraksi
        </h2>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12">
          <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
          <p class="text-gray-500">Belum ada data</p>
          <p class="text-gray-400 text-sm">Upload foto KTP untuk memulai ekstraksi</p>
        </div>

        <!-- Result Data -->
        <div id="resultSection" class="hidden space-y-3">
          <!-- Data items will be inserted here -->
        </div>

        <!-- Copy JSON Button -->
        <div id="actionButtons" class="hidden mt-6 flex space-x-3">
          <button 
            id="copyJsonBtn" 
            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300"
          >
            <i class="fas fa-copy mr-2"></i>
            Salin JSON
          </button>
          <button 
            id="downloadBtn" 
            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300"
          >
            <i class="fas fa-download mr-2"></i>
            Download
          </button>
        </div>
      </div>
    </div>

    <!-- Tips Section -->
    <div class="mt-8 bg-amber-50 border border-amber-200 rounded-2xl p-6">
      <h3 class="font-semibold text-amber-800 mb-3">
        <i class="fas fa-lightbulb mr-2"></i>
        Tips untuk Hasil Optimal
      </h3>
      <ul class="text-amber-700 text-sm space-y-2">
        <li><i class="fas fa-check text-amber-500 mr-2"></i>Pastikan foto KTP tidak blur dan terbaca jelas</li>
        <li><i class="fas fa-check text-amber-500 mr-2"></i>Gunakan pencahayaan yang cukup</li>
        <li><i class="fas fa-check text-amber-500 mr-2"></i>Foto seluruh bagian KTP tanpa terpotong</li>
        <li><i class="fas fa-check text-amber-500 mr-2"></i>Hindari pantulan cahaya pada KTP</li>
      </ul>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-12 py-6 text-center text-gray-500 text-sm">
    <p>Powered by Google Gemini Flash AI</p>
    <p class="mt-1 text-xs text-gray-400">Data tidak disimpan di server</p>
  </footer>

  <!-- Error Popup Modal -->
  <div id="errorModal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeErrorModal()"></div>
    
    <!-- Modal Content -->
    <div class="fixed inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm sm:max-w-md mx-auto my-8 transform transition-all scale-100 animate-bounce-in">
        <!-- Header -->
        <div class="bg-red-500 rounded-t-2xl px-4 sm:px-6 py-4">
          <div class="flex items-center space-x-3">
            <div class="bg-white bg-opacity-20 p-2 rounded-full flex-shrink-0">
              <i class="fas fa-exclamation-triangle text-white text-lg sm:text-xl"></i>
            </div>
            <h3 id="modalErrorTitle" class="text-white text-base sm:text-lg font-bold truncate">Oops! Terjadi Kesalahan</h3>
          </div>
        </div>
        
        <!-- Body -->
        <div class="px-4 sm:px-6 py-5 max-h-60 overflow-y-auto">
          <div class="flex items-start space-x-3 sm:space-x-4">
            <div class="flex-shrink-0 hidden sm:block">
              <div class="w-10 h-10 sm:w-12 sm:h-12 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-id-card text-red-500 text-lg sm:text-xl"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p id="modalErrorMessage" class="text-gray-600 text-sm sm:text-base break-words"></p>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gray-50 rounded-b-2xl px-4 sm:px-6 py-4">
          <button 
            onclick="closeErrorModal()" 
            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 sm:py-3 px-6 rounded-xl transition-all duration-300 text-sm sm:text-base"
          >
            <i class="fas fa-times mr-2"></i>
            Tutup
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes bounce-in {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        transform: scale(1);
      }
    }
    .animate-bounce-in {
      animation: bounce-in 0.5s ease-out;
    }
  </style>

  <script>
    // Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const previewContainer = document.getElementById('previewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const fileName = document.getElementById('fileName');
    const extractBtn = document.getElementById('extractBtn');
    const resetBtn = document.getElementById('resetBtn');
    const loadingSection = document.getElementById('loadingSection');
    const errorSection = document.getElementById('errorSection');
    const errorMessage = document.getElementById('errorMessage');
    const emptyState = document.getElementById('emptyState');
    const resultSection = document.getElementById('resultSection');
    const actionButtons = document.getElementById('actionButtons');
    const copyJsonBtn = document.getElementById('copyJsonBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const errorModal = document.getElementById('errorModal');
    const modalErrorTitle = document.getElementById('modalErrorTitle');
    const modalErrorMessage = document.getElementById('modalErrorMessage');

    let selectedFile = null;
    let extractedData = null;

    // Field labels mapping
    const fieldLabels = {
      nik: 'NIK',
      nama: 'Nama',
      tempat_lahir: 'Tempat Lahir',
      tanggal_lahir: 'Tanggal Lahir',
      jenis_kelamin: 'Jenis Kelamin',
      alamat: 'Alamat',
      rt_rw: 'RT/RW',
      kelurahan: 'Kelurahan/Desa',
      kecamatan: 'Kecamatan',
      kabupaten_kota: 'Kabupaten/Kota',
      provinsi: 'Provinsi',
      agama: 'Agama',
      status_perkawinan: 'Status Perkawinan',
      pekerjaan: 'Pekerjaan',
      kewarganegaraan: 'Kewarganegaraan',
      berlaku_hingga: 'Berlaku Hingga'
    };

    // Drop zone events
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    // Handle file selection
    function handleFile(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showError('File harus berupa gambar (JPG, PNG, WebP)', 'Format File Salah');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showError('Ukuran file maksimal 5MB', 'File Terlalu Besar');
        return;
      }

      selectedFile = file;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        imagePreview.src = e.target.result;
        fileName.textContent = file.name;
        uploadPlaceholder.classList.add('hidden');
        previewContainer.classList.remove('hidden');
        extractBtn.disabled = false;
        hideError();
      };
      reader.readAsDataURL(file);
    }

    // Extract button click
    extractBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      // Show loading
      loadingSection.classList.remove('hidden');
      extractBtn.disabled = true;
      hideError();
      hideResult();

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        const response = await fetch('/api/extract-ktp', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          extractedData = result.data;
          showResult(result.data);
        } else {
          // Cek apakah error karena bukan KTP
          if (result.error && result.error.toLowerCase().includes('bukan ktp')) {
            showError(result.error, 'Bukan KTP!');
          } else {
            showError(result.error || 'Gagal mengekstrak data KTP', 'Terjadi Kesalahan');
          }
        }
      } catch (error) {
        showError('Terjadi kesalahan koneksi. Silakan coba lagi.', 'Koneksi Error');
      } finally {
        loadingSection.classList.add('hidden');
        extractBtn.disabled = false;
      }
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
      selectedFile = null;
      extractedData = null;
      fileInput.value = '';
      imagePreview.src = '';
      fileName.textContent = '';
      uploadPlaceholder.classList.remove('hidden');
      previewContainer.classList.add('hidden');
      extractBtn.disabled = true;
      hideError();
      hideResult();
    });

    // Show result
    function showResult(data) {
      emptyState.classList.add('hidden');
      resultSection.classList.remove('hidden');
      actionButtons.classList.remove('hidden');

      resultSection.innerHTML = '';

      // Display each field
      for (const [key, label] of Object.entries(fieldLabels)) {
        const value = data[key];
        if (value !== null && value !== undefined) {
          const item = document.createElement('div');
          item.className = 'bg-gray-50 rounded-lg p-3';
          item.innerHTML = `
            <p class="text-xs text-gray-500 uppercase tracking-wide">${label}</p>
            <p class="text-gray-800 font-medium mt-1">${value}</p>
          `;
          resultSection.appendChild(item);
        }
      }
    }

    // Hide result
    function hideResult() {
      emptyState.classList.remove('hidden');
      resultSection.classList.add('hidden');
      actionButtons.classList.add('hidden');
      resultSection.innerHTML = '';
    }

    // Show error popup
    function showError(message, title = 'Terjadi Kesalahan') {
      // Simplify error message for user
      let userFriendlyMessage = message;
      
      // Handle network/fetch errors
      if (message.includes('fetch failed') || message.includes('network') || message.includes('ECONNREFUSED')) {
        userFriendlyMessage = 'Gagal terhubung ke server AI. Periksa koneksi internet Anda dan coba lagi.';
        title = 'Koneksi Gagal';
      }
      // Handle API errors
      else if (message.includes('GoogleGenerativeAI Error') || message.includes('generativelanguage.googleapis.com')) {
        userFriendlyMessage = 'Terjadi kesalahan saat memproses gambar. Silakan coba lagi dalam beberapa saat.';
        title = 'Error Server AI';
      }
      // Handle timeout
      else if (message.includes('timeout') || message.includes('Timeout')) {
        userFriendlyMessage = 'Proses memakan waktu terlalu lama. Silakan coba lagi.';
        title = 'Timeout';
      }
      
      document.getElementById('modalErrorTitle').textContent = title;
      modalErrorMessage.textContent = userFriendlyMessage;
      errorModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Close error popup
    function closeErrorModal() {
      errorModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !errorModal.classList.contains('hidden')) {
        closeErrorModal();
      }
    });

    // Hide error (legacy - keeping for compatibility)
    function hideError() {
      // No longer needed with popup
    }

    // Copy JSON
    copyJsonBtn.addEventListener('click', () => {
      if (!extractedData) return;
      
      navigator.clipboard.writeText(JSON.stringify(extractedData, null, 2))
        .then(() => {
          copyJsonBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Tersalin!';
          setTimeout(() => {
            copyJsonBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>Salin JSON';
          }, 2000);
        });
    });

    // Download JSON
    downloadBtn.addEventListener('click', () => {
      if (!extractedData) return;

      const blob = new Blob([JSON.stringify(extractedData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ktp-data-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
